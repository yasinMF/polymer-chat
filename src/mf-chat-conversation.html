<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Chat Login auths a user via Google sign in, and creates a record for them if they're a new user -->

<dom-module id="mf-chat-conversation">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        position: relative;
        background-color: red;
      }

    </style>



    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/conversation/:conversationId"
      data="{{routeData}}"
      ></app-route>

    <firebase-document
      id="conversationDocument"
      app-name="mf-chat"
      path="conversations/[[routeData.conversationId]]"
      data="{{conversation}}">
    </firebase-document>



    <app-header-layout fullbleed has-scrolling-region>
      <app-header>
        <app-toolbar>

          <a href="/home"><paper-icon-button icon="arrow-back"></paper-icon-button></a>
          <div main-title>[[_getConversationName(conversation.members, user.uid)]]</div>

        </app-toolbar>

      </app-header>
      <div class="content">
        
      <template is="dom-repeat" items="[[conversation.messages]]" as="message">
        <template is="dom-if" if="[[_isEqual(message.type, 'annotation')]]">
          <p class="annotation">[[message.content]]</p>
        </template>

        <template is="dom-if" if="[[_isEqual(message.type, 'text')]]">
          <p class="text">[[message.content]]</p>
        </template>


      </template>
      
      </div>
    </app-header-layout>

    <div class="footer-button" id="message-control">
      <paper-textarea id="messageInput" placeholder="Message..." class="flex" value="{{userMessage}}" on-keydown="_onKeydown" no-label-float></paper-textarea>
    </div>

  </template>

  <script>
    Polymer({
      is: 'mf-chat-conversation',

      behaviors:[MfChatUtilityBehavior],

      _onKeydown:function(e){
        if(!e.shiftKey && e.code == "Enter"){
          e.preventDefault();
          e.stopPropagation();
          this._sendTextMessage();
        }
      },

      _sendTextMessage:function(){
        let message = {
          type:'text',
          content:this.userMessage,
          user:this.user,
          timestamp:Date.now()
        }

        this.push('conversation.messages', message);
        this.userMessage = null;
      }


    });
  </script>
</dom-module>

