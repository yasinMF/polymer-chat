<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Chat Login auths a user via Google sign in, and creates a record for them if they're a new user -->

<dom-module id="mf-chat-conversation">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        position: relative;
        background-color: #efefef;
      }

      .content {
          padding: 0 2rem 3rem;
      }

      .annotation {
          font-size: .75em;
          opacity: .75;
      }

      .message {
          background: #fff;
          overflow: hidden;
          padding: 0 .8rem;
          margin: .5rem 0;
      }

      .message.me {
          text-align: right;
          background: #6f6f6f;
          color: #fff;
      }

      .markdown-html a,
      .markdown-html a:visited {
          color: inherit;
          text-decoration: underline;
      }

      .markdown-html img {
          max-width: 100%;
      }

    </style>



    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/conversation/:conversationId"
      data="{{routeData}}"
      ></app-route>

    <firebase-document
      id="conversationDocument"
      app-name="mf-chat"
      path="conversations/[[routeData.conversationId]]"
      data="{{conversation}}">
    </firebase-document>



    <app-header-layout fullbleed has-scrolling-region>
      <app-header>
        <app-toolbar>

          <a href="/home"><paper-icon-button icon="arrow-back"></paper-icon-button></a>
          <div main-title>[[_getConversationName(conversation.members, user.uid)]]</div>

        </app-toolbar>

      </app-header>
      <div class="content">

      <template is="dom-repeat" items="[[conversation.messages]]" as="message">
        <template is="dom-if" if="[[_isEqual(message.type, 'annotation')]]">
          <p class="annotation">[[message.content]]</p>
        </template>

        <template is="dom-if" if="[[_isEqual(message.type, 'text')]]">
            <div class$="message [[_themOrMe(message.user.uid, user.uid)]]" data-uid$="[[message.user.uid]]">
                <marked-element markdown="[[message.content]]">
                    <div class="markdown-html"></div>
                </marked-element>
            </div>
        </template>


      </template>

      </div>
    </app-header-layout>

    <div class="footer-button" id="message-control">
      <paper-textarea id="messageInput" placeholder="Message..." class="flex" value="{{userMessage}}" on-keydown="_onKeydown" no-label-float></paper-textarea>
    </div>

  </template>

  <script>
    Polymer({
      is: 'mf-chat-conversation',

      properties: {
          conversation: {
              type: Object,
              value: {},
          },
          numMessages: {
              type: Number,
              value: 0,
          },
      },

      observers: [
          '_onMessagesChanged(conversation.messages.*)',
          '_onReceiveMessage(numMessages)',
      ],

      behaviors:[MfChatUtilityBehavior],

      _onKeydown:function(e){
        if(!e.shiftKey && e.code == "Enter"){
          e.preventDefault();
          e.stopPropagation();
          this._sendTextMessage();
        }
      },

      _sendTextMessage:function(){
        let message = {
          type:'text',
          content:this.userMessage,
          user:this.user,
          timestamp:Date.now()
        }

        this.push('conversation.messages', message);
        this.userMessage = null;
    },

    _onMessagesChanged: function(x) {
        if (!this.conversation || !this.conversation.messages) {
            return;
        }

        let newNumMessages = this.conversation.messages.length || 0;

        if (newNumMessages != this.numMessages) {
            this.set('numMessages', newNumMessages);
        }
    },

      _onReceiveMessage: function(numMessages) {
          if (!Push || !numMessages) {
              // the push.js library hasn't loaded or we don't have any messages
              return;
          }

          let message = this.conversation.messages[numMessages - 1];

          if (this.user.uid === message.user.uid) {
              // the current user wrote the last message
              return;
          }

            Push.create(message.user.name, {
                body: message.content,
                icon: message.user.avatar,
                timeout: 10000,
                onClick: function() {
                    window.focus();
                    this.close();
                }
            });
      },

      _themOrMe: function(messageUid, userUid) {
          return messageUid === userUid ? 'me' : 'not-me';
      },

    });
  </script>
</dom-module>
