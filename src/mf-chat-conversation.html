<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Chat Login auths a user via Google sign in, and creates a record for them if they're a new user -->

<dom-module id="mf-chat-conversation">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        position: relative;
        background-color: #11232B;
      }

      app-header-layout{
        bottom: 8rem;
      }

      .annotation {
          font-size: .75em;
      }

      .message-wrapper .message {
          background: rgba(255, 255, 255, 0.1);
          overflow: hidden;
          padding: 0 1rem;
          margin-top: 0.125rem;
          margin-bottom: 0.125rem;
          border-radius: 1rem;
          /*min-width: 50%;*/
          color: #fff;
          /*margin: .5rem 0;*/
      }

      .message-wrapper .message p{
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .message-wrapper{
        @apply(--layout-start);
      }

      .me{
        @apply(--layout-end);
      }

      .me .message {
          background-color: var(--primary-color);
          text-align: right;

          /*background: #6f6f6f;*/
          color: #fff;
      }

      .markdown-html a,
      .markdown-html a:visited {
          color: inherit;
          text-decoration: underline;
      }

      .markdown-html img {
          max-width: 100%;
      }

      .annotation{
        padding: 1.5rem;
        text-align: center;
      }

      .footer-button{
        padding: 1.5rem;
      }

      .footer-button .text-area{
        padding: 1.5rem;
        background-color: #fff;
      }

      .content{
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }

      #end{
        width: 100%;
        padding-bottom: 8rem;
      }

      .avatar.img-wrapper{
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
        width: 32px;
        height: 32px;
        border-radius: 16px;
        overflow: hidden;
        background-color: #263238;
      }

      .avatar.img-wrapper iron-image{
        width: 32px;
        height: 32px;
      }

      #send-button{
        color: var(--primary-color);
        margin-left: 1rem;
      }

      #send-button[disabled]{
        color: var(--divider-color);
      }
    </style>



    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/conversation/:conversationId"
      data="{{routeData}}"
      ></app-route>

    <firebase-document
      id="conversationNameDocument"
      app-name="mf-chat"
      path="users/[[user.uid]]/conversations/[[routeData.conversationId]]/name"
      data="{{conversationName}}">
    </firebase-document>

    <firebase-document
      id="conversationMembersDocument"
      app-name="mf-chat"
      path="conversations/[[routeData.conversationId]]/members"
      data="{{conversationMembers}}">
    </firebase-document>

    <firebase-query
      id="query"
      app-name="mf-chat"
      path="conversations/[[routeData.conversationId]]/messages"
      data="{{messages}}">
    </firebase-query>

    <iron-media-query query="(min-width: 640px)" query-matches="{{wideLayout}}"></iron-media-query>

    <app-header-layout fullbleed has-scrolling-region>
      <app-header class="inverse" reveals>
        <app-toolbar>
        
          <a href="/home" hidden$="[[wideLayout]]"><paper-icon-button icon="arrow-back"></paper-icon-button></a>
          <div main-title>
            <h1 class="title">[[conversationName]]</h1>
          </div>

        </app-toolbar>

      </app-header>
      <div class="content" id="messages">

      <template is="dom-repeat" items="[[messages]]" as="message">

        <template is="dom-if" if="[[_isEqual(message.type, 'annotation')]]">
          <p class="annotation small inverse message">[[message.content]] â€“ <moment-js date="[[message.timestamp]]" from-now utc></p>
        </template>

        <template is="dom-if" if="[[_isEqual(message.type, 'text')]]">

          <p class="annotation small inverse message" hidden$="[[!_shouldShowTimeAnnotation(message, index)]]"><moment-js date="[[message.timestamp]]" from-now utc></moment-js></p>

          <div class$="vertical layout message-wrapper [[_themOrMe(message.user.uid, user.uid)]]">
            <div class="message" data-uid$="[[message.user.uid]]">
                <marked-element markdown="[[message.content]]">
                    <div class="markdown-html"></div>
                </marked-element>
            </div>

            <div class="img-wrapper avatar" hidden$="[[!_shouldShowAvatar(message, index)]]">
              <iron-image src="[[message.user.avatar]]" sizing="contain" preload fade></iron-image>
            </div>


          </div>

        </template>


      </template>

      <div id="end"></div>

      </div>
    </app-header-layout>

    <div class="footer-button" id="message-control">
      <div class="text-area horizontal layout center">
        <paper-textarea id="messageInput" placeholder="Message [[conversationName]]..." class="flex" value="{{userMessage}}" on-keydown="_onKeydown" no-label-float></paper-textarea>
        <paper-icon-button disabled$="[[!userMessage]]" id="send-button" icon="send" on-tap="_sendTextMessage"></paper-icon-button>
      </div>
    </div>

  </template>

  <script>
    Polymer({
      is: 'mf-chat-conversation',

      properties: {

          appName:{
            type:String,
            value:'mf-chat'
          },
          conversation: {
              type: Object,
              value: {},
          },
          numMessages: {
              type: Number,
              value: 0,
          },

          userMessage:{
            type: String,
            value: null
          }


      },

      observers: [
          '_onMessagesChanged(messages.*)',
          // '_onReceiveMessage(numMessages)',
          '_conversationNameChanged(conversationName)'
      ],

      behaviors:[MfChatUtilityBehavior],

      attributeChanged: function(name, type) {
        // be aware of when the page is shown, and reset the state.
        // console.log('Showing search page', this.routeData.productId);

        if(this.getAttribute(name).includes('iron-selected')){
          console.log('page got shown');

        }
      },

      _conversationNameChanged:function(){
        console.log('conversation name changed');
      },

      _onKeydown:function(e){
        if(!e.shiftKey && e.code == "Enter"){
          e.preventDefault();
          e.stopPropagation();
          this._sendTextMessage();
        }
      },

      _sendTextMessage:function(){
        let message = {
          type:'text',
          content:this.userMessage,
          user:this.user,
          timestamp:Date.now()
        }

        // this.push('conversation.messages', message);
        this._addMessageToConversation(message, this.routeData.conversationId, Object.keys(this.conversationMembers));
        this.userMessage = null;
      },

      _onMessagesChanged:function(){
        this.async(function(){
          // var messages = Polymer.dom(this.$.messages).querySelectorAll('.message');
          // if(messages.length > 0){
          //   var message = messages[messages.length-1];
          //   message.scrollIntoView(false);
          // }
          this.$.end.scrollIntoView(false);
          this.db.ref('users/'+this.user.uid+'/conversations/'+this.routeData.conversationId+'/lastSeen').set(Date.now());
        }, 1);
      },

      _themOrMe: function(messageUid, userUid) {
          return messageUid === userUid ? 'me' : 'not-me';
      },

      _shouldShowAvatar: function(message, index){
        if(index == this.messages.length-1){
          console.log('last message!');
          return true;
        }

        var nextMessage = this.messages[index+1]
        if(nextMessage.user.uid == message.user.uid){
          return false;
        }else{
          return true;
        }
      },

      _shouldShowTimeAnnotation :function(message, index){
        if(index == 0){
          console.log('last message!');
          return true;
        }

        var lastMessage = this.messages[index-1]
        if((message.timestamp - lastMessage.timestamp) > 120000){
          return true;
        }else{
          return false;
        }

      }

    });
  </script>
</dom-module>
