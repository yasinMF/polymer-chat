<script type="text/javascript">
	
	MfChatAuthBehavior = {
		properties:{
			user:{
				type:Object,
				notify:true
			},

		  statusKnown:{
        type:Boolean,
        value:null,
        notify: true
      },

      signedIn:{
        type:Boolean,
        value:null,
        notify:true
      },

      userPath:{
      	type:String,
      	value:null
      },

      auto:{
      	type:Boolean,
      	value: true
      }
		},

		observers:[
			'_authDataChanged(authData)'
		],

		_handleError:function(e, d){
			console.log('error', e, d);
			this.message = d.message;
			this.$.toast.open();
		},

		_authDataChanged:function(){
			
			if(this.authData && this.auto){
				console.log('auth data changed', this.authData, this.auto);
				this.userPath = 'users/'+this.authData.uid;
			}
		},

		_signInWithGoogle:function(){
      this.$.auth.signInWithPopup('google').then(function(authResponse){
      	this.auto = false;
      	console.log('logged in via google');

      	this._createUserIfNotExists(authResponse.user);

      }.bind(this));
    },

    _signInWithEmail:function(){
      this.$.auth.signInWithEmailAndPassword(this.email, this.password).then(function(authResponse){
      	this.auto = false;
      	console.log('logged in via email', authResponse);

      	this._createUserIfNotExists(authResponse);

      }.bind(this));
    },

    _signOut:function(){
    	this.$.auth.signOut().then(function(){
    		console.log('signed out');

    		this.async(function(){
          this.$.userDocument.reset();
					this.set('user', '');
	    		this.auto = true;
    		}, 1)
    		
    	}.bind(this));
    	
    },

    _createNewUser:function(){
      this.$.auth.createUserWithEmailAndPassword(this.email, this.password).then(function(authResponse){
        console.log('creating user', this.username);
        this.auto = false;
        // authResponse.displayName = this.username;
        this._createUserIfNotExists(authResponse);  

      }.bind(this)); 
    },

    _checkIfUserExists:function(userId) {
      var promise =  new Promise(function(resolve, reject){
      	
    		var usersRef = this.$.userDocument.ref;
        console.log(usersRef, userId)
        usersRef.once('value', function(snapshot) {
        var exists = (snapshot.val() !== null);
          resolve(exists);
        });
      	
        
      }.bind(this))
      return promise;
    },

    _createUserIfNotExists:function(authResponse){
    	console.log(authResponse)
    	this.userPath = 'users/'+authResponse.uid
    	this._checkIfUserExists(authResponse.uid).then(function(userExists){
    		console.log('user exists', userExists);
    		
    		console.log('user is', this.user, authResponse, this.username)
    		

    		if(!userExists){
    			let username = this.username ? this.username : '';

    			let user = {
	          name:authResponse.displayName ? authResponse.displayName : username,
	          email:authResponse.email,
	          avatar:authResponse.photoURL,
	          uid:authResponse.uid
	        }
	        this.set('user', user);


	        this.$.userDocument.save('users', authResponse.uid).then(function(){
	        	console.log('user created');
	        	if(this.isSignup){
	        		this.$.userDocument.reset();
	        	}
	        }.bind(this))
    		}

    	}.bind(this))
    }
	}

</script>