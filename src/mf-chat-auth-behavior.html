<script type="text/javascript">
	
	MfChatAuthBehavior = {
		properties:{
      user:{
        type:Object,
        notify:true
      },

		  statusKnown:{
        type:Boolean,
        value:null,
        notify: true
      },

      signedIn:{
        type:Boolean,
        value:null,
        notify:true
      },
		},

		observers:[
			'_authDataChanged(authData)',
		],


		_handleError:function(e, d){
			console.log('error', e, d);
			this.message = d.message;
			this.$.toast.open();
		},

		_authDataChanged:function(){
			
			if(this.authData){
				this._createUserIfNotExists(this.authData); 
			}  
		},

		_signInWithGoogle:function(){
      this.$.auth.signInWithPopup('google').then(function(authResponse){

      	console.log('logged in via google', authResponse);

      	this._createUserIfNotExists(authResponse.user);

      }.bind(this));
    },

    _signInWithEmail:function(){
      this.$.auth.signInWithEmailAndPassword(this.email, this.password).then(function(authResponse){
      	console.log('logged in via email', authResponse);

      	this._createUserIfNotExists(authResponse);

      }.bind(this));
    },

    _signOut:function(){
    	this.$.auth.signOut().then(function(){
    		console.log('signed out');
        this.userPath = null;
        this.$.userDocument.reset();
        this.set('user', null);

        console.log(this.$.userDocument)
    		
    	}.bind(this));
    	
    },

    _createNewUser:function(){
      this.$.auth.createUserWithEmailAndPassword(this.email, this.password).then(function(authResponse){
        console.log('creating user', this.username);
        this.auto = false;
        // authResponse.displayName = this.username;
        this._createUserIfNotExists(authResponse);  

      }.bind(this)); 
    },

    _checkIfUserExists:function() {
      var promise =  new Promise(function(resolve, reject){
          
          let ref = this.$.userDocument.ref;
          ref.once('value', function(snapshot) {
          let exists = (snapshot.val() !== null);
            resolve(exists);
          });
        }.bind(this))
        return promise;
    },

    _createUserIfNotExists:function(authResponse){

    	this.userPath = 'users/'+authResponse.uid;
      
    	this._checkIfUserExists().then(function(userExists){

    		if(!userExists){
    			let username = this.username ? this.username : '';
          let name = authResponse.displayName ? authResponse.displayName : username
    			let user = {
	          name:name,
            lowercaseName:name.toLowerCase(),
	          email:authResponse.email,
	          avatar:authResponse.photoURL,
	          uid:authResponse.uid
	        }
	        this.set('user', user);


	        this.$.userDocument.save('users', authResponse.uid).then(function(){
	        	console.log('user created');
	        	if(this.isSignup){
	        		this.$.userDocument.reset();
	        	}
	        }.bind(this))
    		}

    	}.bind(this))
    }
	}

</script>