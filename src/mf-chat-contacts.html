<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Chat Login auths a user via Google sign in, and creates a record for them if they're a new user -->

<dom-module id="mf-chat-contacts">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
      }

      paper-button{
        border-radius: 0px;
      }

      paper-item{
        --paper-item-focused-before:{
          display: none;
        };
      }

      paper-input{
        width: 100%;
      }

      .contact-chip{
        background-color: rgba(0,0,0,0.12);
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        margin: 0.25rem;
        border-radius: 100px;
      }

      .contact-chip span{
        display: block;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      app-header{
        background-color: #fff;
      }
    </style>


    <firebase-query
      id="searchQuery"
      app-name="mf-chat"
      order-by-child="name"
      data="{{queryResponse}}">
    </firebase-query>

    <firebase-document
      id="conversationsDocument"
      app-name="mf-chat"
      path="[[conversationPath]]"
      data="{{conversation}}">
    </firebase-document>



    <app-header>
      <div class="horizontal layout">
        <a href="/home"><paper-icon-button icon="arrow-back"></paper-icon-button></a>
        <div>
          <iron-selector class="flex horizontal layout wrap" selected-values="{{selectedContacts}}" multi items="[[contacts]]" attr-for-selected="value">
            <template is="dom-repeat" items="[[selectedContacts]]" as="contact">
              <div class="contact-chip horizontal layout" value="[[contact]]">
                <span>
                  [[contact.name]]
                </span>
                <iron-icon icon="close"></iron-icon>

              </div>
            </template>
          </iron-selector>
          
          <paper-input value="{{searchTerm}}" placeholder="Enter a name..." no-label-float></paper-input>
        </div>
      </div>
    </app-header>

    <div class="content">
      <iron-selector selected-values="{{selectedContacts}}" multi items="[[contacts]]" attr-for-selected="value" >
        <template id="contactList" is="dom-repeat" items="[[contacts]]" as="contact" filter="_contactFilter">
          <paper-item value="[[contact]]">
            <paper-item-body two-line>
              <div>[[contact.name]]</div>
              <div secondary>[[contact.email]]</div>
            </paper-item-body>
          </paper-item>
        </template>
      </iron-selector>
    </div>


    <div class="footer-button">
      <paper-button on-tap="_createConversationIfNotExists">
        Send message
      </paper-button>
    </div>

    
    <!-- [[loading]] -->


  </template>

  <script>
    Polymer({
      is: 'mf-chat-contacts',

      properties:{
        queryResponse: {
          type: Object,
        },

        loading:{
          type: Boolean,
          value: true
        }
      },

      observers:[
        '_queryChanged(searchTerm, user.uid)',
      ],

      _queryChanged:function(query){
        console.log('query changed')

      
        this.async(function(){
          this.$.searchQuery.reset();
          this.$.searchQuery.path = 'users';

          this.loading = true;
          let ref = this.$.searchQuery.ref;
          ref.once('value', function(snapshot) {
            
            this.loading = false;
            this.set('contacts', [])
            this.set('contacts', this.queryResponse);
            console.log('complete', this.contacts, this.queryResponse)

            this.$.contactList.render();
          }.bind(this));

        })
      },

      _contactFilter:function(item){
        return item.uid != this.user.uid && item.name.toLowerCase().includes(this.searchTerm.toLowerCase()) 
      },

      _createConversationIfNotExists:function(){

        var members = [this.user].concat(this.selectedContacts);
        
        let keys = members.map(function(item){
          return item.uid
        });

        let conversationId = this._getConversationId(keys)
        
        this.conversationPath = 'conversations/'+conversationId;

        this._checkIfConversationExists().then(function(conversationExists){
          console.log('conversation exists', conversationExists);
          if(conversationExists){
            // window.location = '/conversation/'+conversationId
          }else{
            

            let initalMessage = {
              type:'annotation',
              content:'Chat started',
              timestamp:Date.now()
            }

            let conversation = {
              messages:[initalMessage],
              members:members.map(function(item){
                delete item.email;
                delete item.$key;
                return item;
              }),
              userAccess:{}
            }

            keys.forEach(function(item){
              conversation.userAccess[item] = true;
            })

            console.log('creating conversation', conversation, conversationId)

            this.set('conversation', conversation);
            this.$.conversationsDocument.save('conversations', conversationId).then(function(response){
              console.log('created conversation');
              // this.$.conversationsDocument.reset();
              // window.location = '/conversation/'+conversationId
            }.bind(this))

          } 
        }.bind(this));
      },

      _getConversationId:function(keys){
        return keys.sort().join('').split('').reduce(function(prevHash, currVal){
          return ((prevHash << 5) - prevHash) + currVal.charCodeAt(0)
        }, 0);
      },

      _checkIfConversationExists:function() {
        var promise =  new Promise(function(resolve, reject){
          
          let conversationRef = this.$.conversationsDocument.ref;
          conversationRef.once('value', function(snapshot) {
          let exists = (snapshot.val() !== null);
            resolve(exists);
          });
        }.bind(this))
        return promise;
      }

    });
  </script>
</dom-module>

