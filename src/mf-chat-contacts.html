<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Chat Login auths a user via Google sign in, and creates a record for them if they're a new user -->

<dom-module id="mf-chat-contacts">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        position: relative;
      }

      paper-button{
        border-radius: 0px;
      }


      paper-item{
        --paper-item-focused-before:{
          display: none;
        };
      }

      app-header{
        background-color: var(--dark-background-color);
      }

      .content{
        padding-top: 1rem;
        padding-bottom: 6rem;
      }

      .toolbar{
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }

      .toolbar iron-selector{
        margin-left: -0.25rem;
        margin-right: -0.25rem;
      }

      .contact-chip{
        background-color: #fff;
        /*padding-top: 0.25rem;
        padding-bottom: 0.25rem;*/
        /*padding-left: 0.5rem;*/
        padding-right: 0.5rem;
        margin: 0.25rem;
        border-radius: 100px;
        color: var(--primary-text-light);
        cursor: pointer;
        overflow: hidden;
      }

      .contact-chip span{
        display: block;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      .contact-chip iron-icon{
        color: var(--secondary-text-light);
      }

      .contact-chip .img-wrapper{
        width: 32px;
        height: 32px;
        border-radius: 16px;
        overflow: hidden;
        background-color: #263238;
      }

      .contact-chip .img-wrapper iron-image{
        width: 32px;
        height: 32px;
      }

      paper-input{
        width: 100%;
        color: #fff;
        --paper-input-container-color: var(--secondary-text-dark);
        --paper-input-container-input-color: #fff;
      }
    </style>

    <app-location route="{{route}}"></app-location>

    <app-header-layout id="layout" fullbleed has-scrolling-region>
      <app-header class="inverse">
        <app-toolbar>
          <a href="/home"><paper-icon-button icon="arrow-back"></paper-icon-button></a>
          <div main-title>
            <h1 class="title">New conversation</h1>
          </div>
        </app-toolbar>

        <div class="toolbar">
          <iron-selector class="flex horizontal layout wrap" selected-values="{{selectedContacts}}" multi items="[[contacts]]" attr-for-selected="value">
            <template is="dom-repeat" items="[[selectedContacts]]" as="contact">
              <div class="contact-chip horizontal layout center" value="[[contact]]">
                <div class="img-wrapper">
                  <iron-image src="[[contact.avatar]]" sizing="contain" preload fade></iron-image>
                </div>
                <span>
                  [[contact.name]]
                </span>
                <iron-icon icon="close"></iron-icon>
              </div>
            </template>
          </iron-selector>
          
          <paper-input id="search" value="{{searchTerm}}" placeholder="Enter a name..." no-label-float></paper-input>

        </div>

      </app-header>

      <div class="content">
        <iron-selector selected-values="{{selectedContacts}}" multi items="[[contacts]]" attr-for-selected="value" selected-attribute="selected">

          <template id="contactList" is="dom-repeat" items="[[contacts]]" as="contact" filter="_contactFilter">
            <mf-chat-contact-item value="[[contact]]" contact="[[contact]]"></mf-chat-contact-item>


          </template>

        </iron-selector>
      </div>
    </app-header-layout>


    <div class="footer-button">
      <paper-button class="primary" on-tap="_createConversationIfNotExists">
        Send message
      </paper-button>
    </div>

    
    <!-- [[loading]] -->


  </template>

  <script>
    Polymer({
      is: 'mf-chat-contacts',

      behaviors: [
        MfChatUtilityBehavior
      ],

      properties:{
        appName:{
          type:String,
          value:'mf-chat'
        },

        queryResponse: {
          type: Object,
        },

        loading:{
          type: Boolean,
          value: true
        },

        searchTerm:{
          type:String,
          value:''
        }
      },

      observers:[
        '_searchTermChanged(searchTerm)',
        '_userChanged(user.uid)',
        '_selectedChanged(selectedContacts.*)'
      ],

      attributeChanged: function(name, type) {
        if(this.getAttribute(name).includes('iron-selected')){
          this.searchTerm = '';
          this.set('selectedContacts', []);
          this.$.search.focus();
        }
      },

      _searchTermChanged:function(){
        this.db.ref('users').orderByChild('lowercaseName').startAt(this.searchTerm).limitToFirst(20).once('value', function(snapshot){
          console.log('Users are', snapshot.val());
          this.set('contacts', Object.values(snapshot.val()));
        }.bind(this));
      },

      _userChanged:function(){
        this.$.contactList.render();
      },

      _selectedChanged:function(){
        this.$.layout.notifyResize();
      },

      _contactFilter:function(item){
        return item.uid != this.user.uid && item.name.toLowerCase().includes(this.searchTerm.toLowerCase()) 
      },

      _createConversationIfNotExists:function(){

        var members = [this.user].concat(this.selectedContacts);
        
        var keys = members.map(function(item){
          return item.uid
        });

        var conversationId = this._getConversationId(keys)

        this._checkIfConversationExists(conversationId).then(function(conversationExists){
          console.log('conversation exists', conversationExists);
          if(conversationExists){
            this.set('route.path', '/conversation/'+conversationId)
          }else{
            
            console.log('creating conversation', conversationId);

            var membersObj = {}
            keys.forEach(function(item){
              membersObj[item] = true
            });

            var conversation = {
              members:membersObj
            }

            var mergedUpdate = {}
            mergedUpdate['conversations/'+conversationId] = conversation;

            

            keys.forEach(function(item){
              var conversationName = ''

              for(var i=0; i<members.length; i++){
                var member = members[i];
                if(member.uid != item){
                  conversationName = conversationName+member.name;

                  if(i < members.length-1){
                    // console.log(i, members.length)
                    conversationName = conversationName+', '
                  }
                } 
              }

              mergedUpdate['users/'+item+'/conversations/'+conversationId] = {
                name:conversationName,
                lastUpdated:Date.now()
              };
            });

            this.db.ref().update(mergedUpdate).then(function(){
              console.log('updated all the shit');
              var initalMessage = {
                type:'annotation',
                content:'Chat started',
                timestamp:Date.now(),
                user:this.selectedContacts[0]
              }
              this._addMessageToConversation(initalMessage, conversationId, keys).then(function(){
                this.set('route.path', '/conversation/'+conversationId);
              }.bind(this));

              
            }.bind(this));

          } 
        }.bind(this));
      },


      _getConversationId:function(keys){
        return keys.sort().join('').split('').reduce(function(prevHash, currVal){
          return ((prevHash << 5) - prevHash) + currVal.charCodeAt(0)
        }, 0);
      },

      _checkIfConversationExists:function(conversationId) {
        var promise =  new Promise(function(resolve, reject){
          
          var conversationRef = this.db.ref('conversations/'+conversationId)
          conversationRef.once('value', function(snapshot) {
          var exists = (snapshot.val() !== null);
            resolve(exists);
          });
        }.bind(this))
        return promise;
      }

    });
  </script>
</dom-module>

