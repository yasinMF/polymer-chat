<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Chat Login auths a user via Google sign in, and creates a record for them if they're a new user -->

<dom-module id="mf-chat-contacts">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
      }

      paper-button{
        border-radius: 0px;
      }

      paper-item{
        --paper-item-focused-before:{
          display: none;
        };
      }

      paper-input{
        width: 100%;
      }
      .contact-chip{
        background-color: rgba(0,0,0,0.12);
        padding: 4px;
      }
    </style>


    <firebase-query
      id="searchQuery"
      app-name="mf-chat"
      path="users"
      order-by-child="name"
      data="{{queryResponse}}">
    </firebase-query>


    <app-header-layout fullbleed>
      <app-header>
        <div class="horizontal layout">

          <div class="flex horizontal layout wrap">

            <template is="dom-repeat" items="[[selectedContacts]]" as="contact">
              <div class="contact-chip horizontal layout">
                [[contact.name]]
              </div>
            </template>

            <paper-input value="{{searchTerm}}" placeholder="Enter a name..." no-label-float></paper-input>

          </div>
        </div>

      </app-header>
      <div class="content">



        <iron-selector selected-values="{{selectedContacts}}" multi items="[[contacts]]" attr-for-selected="value" >
          <template is="dom-repeat" items="[[contacts]]" as="contact" filter="_contactFilter">
            <paper-item value="[[contact]]">
              <paper-item-body two-line>
                <div>[[contact.name]]</div>
                <div secondary>[[contact.email]]</div>
              </paper-item-body>
              <!-- <iron-icon icon="warning"></iron-icon> -->
            </paper-item>
          </template>
        </iron-selector>
    
      </div>
    </app-header-layout>

    <a class="footer-button" href="/contacts">
      <paper-button>
        Send message
      </paper-button>
    </a>

    
    <!-- [[loading]] -->


  </template>

  <script>
    Polymer({
      is: 'mf-chat-contacts',

      properties:{
        queryResponse: {
          type: Object,
        },

        loading:{
          type: Boolean,
          value: true
        }
      },

      observers:[
        '_queryChanged(searchTerm, user.uid)',
        '_selectedContactsChanged(selectedContacts.*)'
      ],

      _selectedContactsChanged:function(){
        console.log(this.selectedContacts)
      },

      _queryChanged:function(query){
        this.loading = true;
        let ref = this.$.searchQuery.ref;
        ref.once('value', function(snapshot) {
          console.log('complete')
          this.loading = false;
          this.set('contacts', [])
          this.set('contacts', this.queryResponse);
        }.bind(this));

      },



      _contactFilter:function(item){

        return item.uid != this.user.uid && item.name.toLowerCase().includes(this.searchTerm.toLowerCase()) 
        

      }

    });
  </script>
</dom-module>

